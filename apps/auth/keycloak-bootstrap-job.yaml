apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-bootstrap
  namespace: keycloak
spec:
  template:
    spec:
      restartPolicy: OnFailure
      automountServiceAccountToken: false
      containers:
        - name: kc-bootstrap
          image: registry.local:5000/keycloak:latest
          command: ["bash", "/bootstrap/bootstrap.sh"]
          envFrom:
            - configMapRef:
                name: keycloak-config
            - secretRef:
                name: keycloak-db-secret
          env:
            - name: KEYCLOAK_URL
              value: "http://keycloak.keycloak.svc.cluster.local:80"
            - name: KEYCLOAK_REALM
              valueFrom:
                configMapKeyRef:
                  name: task-api-config
                  key: KEYCLOAK_REALM
                  optional: true
            - name: KEYCLOAK_CLIENT_ID
              valueFrom:
                configMapKeyRef:
                  name: task-api-config
                  key: KEYCLOAK_ADMIN_CLIENT_ID
                  optional: true
            - name: KEYCLOAK_ADMIN_CLIENT_SECRET
              valueFrom:
                configMapKeyRef:
                  name: task-api-config
                  key: KEYCLOAK_ADMIN_CLIENT_SECRET
                  optional: true
          volumeMounts:
            - name: bootstrap
              mountPath: /bootstrap
          resources:
            requests:
              cpu: "50m"
              memory: "128Mi"
              ephemeral-storage: "128Mi"
            limits:
              memory: "256Mi"
      volumes:
        - name: bootstrap
          configMap:
            name: keycloak-bootstrap
